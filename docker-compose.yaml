services:
  # ----------------------------------------------------------------------
  # 1. DATABASE SERVICE (PostgreSQL)
  # ----------------------------------------------------------------------
  db:
    image: postgres:14.19-alpine3.21
    container_name: postgres_db
    environment:
      POSTGRES_DB: laravel_api_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app-network

  # ----------------------------------------------------------------------
  # 2. LARAVEL API SERVICE (PHP-FPM)
  # - Executes PHP code; needs the pgsql PHP extension installed.
  # ----------------------------------------------------------------------
  backend-php:
    build:
      context: ./backend/vue-laravel
      dockerfile: Dockerfile
      args:
        INSTALL_COMPOSER: 'true'
        INSTALL_PGSQL: 'true'
    container_name: laravel_php
    # Mount the local application code for live file syncing during development
    volumes:
      - ./backend/vue-laravel:/var/www/html # Updated path
    environment:
      # Essential Laravel environment variables
      APP_ENV: local
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: laravel_api_db
      DB_USERNAME: user
      DB_PASSWORD: password
    depends_on:
      - db
    networks:
      - app-network

  # ----------------------------------------------------------------------
  # 3. LARAVEL NGINX PROXY SERVICE
  # - Acts as the public entry point for the API (e.g., http://localhost:8000)
  # - Proxies requests to backend-php:9000
  # ----------------------------------------------------------------------
  backend-nginx:
    image: nginx:alpine
    container_name: laravel_nginx_proxy
    ports:
      - "8000:80"
    volumes:
      - ./nginx/api.conf:/etc/nginx/conf.d/default.conf
      - ./backend/vue-laravel:/var/www/html
    depends_on:
      - backend-php
    networks:
      - app-network

  # ----------------------------------------------------------------------
  # 4. VUE FRONTEND SERVICE
  # - Builds and serves the static Vue application (e.g., http://localhost:8080)
  # ----------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend/client-vue
      dockerfile: Dockerfile
    container_name: vue_frontend
    ports:
      - "8080:8080"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  db-data:
    driver: local
